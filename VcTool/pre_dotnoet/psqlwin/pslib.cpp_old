//===================================================================================================================
//
//	FileName	: pslib.c
//				Postgres用のユーティリティ
//	作成日		:2001.10.22 coba (芝の移植 UNIX+PostgreSQLに移植 オリジナルはWinNT+Oracle)
//	更新日		: 
//===================================================================================================================
#include "pslib.h"

// Postgres用関数変数
//--------------------------------------------------------------------------------------------------------------------
//	int PS_Connect( PGconn** pg)
// 説明　:	PostgreSQLに接続
// 引数１:　データベース接続変数
// 戻り値: 0=成功
//--------------------------------------------------------------------------------------------------------------------
int PS_Connect( PGconn** pg,char* constr)
{
	if( constr==NULL || strlen(constr) < 1 ) return(-2);

//	*pg = PQconnectdb("dbname=seigi user=seigi"); /* データベースへの接続 */
	*pg = PQconnectdb(constr); /* データベースへの接続 */

	/* データベースへの接続失敗? */
	if (PQstatus(*pg) == CONNECTION_BAD) return(-1);

	return(0);
}

//--------------------------------------------------------------------------------------------------------------------
//	int PS_Select( PGconn* pg,PGresult* res, char* sql)
// 説明　:selectを実行
// 引数１:　データベース接続変数
// 引数２:　結果セット受取変数
// 引数３:　発行するSELECT文
// 戻り値: 0未満＝失敗 それ以外＝レコード数
//--------------------------------------------------------------------------------------------------------------------
int PS_Select( PGconn* pg,PGresult** res, char* sql)
{
	*res = PQexec(pg, sql);/* 問い合わせの送信 */
	if (PQresultStatus(*res) != PGRES_TUPLES_OK) return(-101);


	return(PQntuples(*res));        /* 戻ってきた行数 */
}

//--------------------------------------------------------------------------------------------------------------------
//	int PS_Exec( PGconn* pg, char* sql)
// 説明　:update or insertを実行
// 引数１:　データベース接続変数
// 引数３:　発行するinsert or update文
// 戻り値: 0=成功  それ以外＝失敗
//--------------------------------------------------------------------------------------------------------------------
int PS_Exec( PGconn* pg, char* sql)
{
	PGresult* res;

	res = PQexec(pg, sql);/* 問い合わせの送信 */
	if (PQresultStatus(res) != PGRES_TUPLES_OK){
		PQclear(res);
		return(1);
	}

	PQclear(res);
	return(0);
}

//--------------------------------------------------------------------------------------------------------------------
// void PS_Close( PGconn* pg,PGresult* res)
// 説明　:結果セットのクローズ
// 引数１:　結果セット受取変数
//--------------------------------------------------------------------------------------------------------------------
void PS_Close( PGresult* res)
{
	PQclear(res);
}

//--------------------------------------------------------------------------------------------------------------------
//	void PS_DisConnect( PGconn* pg,PGresult* res)
// 説明　:DB接続の開放
// 引数１:　データベース接続変数
// 引数２:　結果セット受取変数
//--------------------------------------------------------------------------------------------------------------------
void PS_DisConnect( PGconn* pg)
{
	PQfinish(pg);
}

